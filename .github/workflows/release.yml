name: Create Release

on:
  push:
    tags:
      - '**'

jobs:
  release:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Parse tag
        id: parse_tag
        run: |
          $tag = "${{ github.ref_name }}"
          Write-Host "Tag: $tag"
          
          # Parse tag format: ModName-v1.2.3 or ModName-v1.2.3.4
          if ($tag -match '^(.+?)-v(\d+\.\d+\.\d+(?:\.\d+)?)$') {
            $modName = $matches[1]
            $version = $matches[2]
            
            # Extract release version without build number (e.g., "1.0.1.4" -> "1.0.1")
            $releaseVersion = $version
            if ($version -match '^(\d+\.\d+\.\d+)\.\d+$') {
              $releaseVersion = $matches[1]
            }
            
            Write-Host "Mod name: $modName"
            Write-Host "Full version: $version"
            Write-Host "Release version (without build): $releaseVersion"
            Write-Output "mod_name=$modName" >> $env:GITHUB_OUTPUT
            Write-Output "version=$version" >> $env:GITHUB_OUTPUT
            Write-Output "release_version=$releaseVersion" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "Invalid tag format. Expected: ModName-v1.2.3 or ModName-v1.2.3.4"
            exit 1
          }
        shell: powershell

      - name: Check for pre-built zip
        id: check_zip
        run: |
          $modName = "${{ steps.parse_tag.outputs.mod_name }}"
          $releaseVersion = "${{ steps.parse_tag.outputs.release_version }}"
          # Zip file uses release version (without build number)
          # Try both path formats to find the file
          $zipPathWindows = "release\$modName-v$releaseVersion.zip"
          $zipPathUnix = "release/$modName-v$releaseVersion.zip"
          
          # Check which path exists
          $foundPath = $null
          if (Test-Path $zipPathWindows) {
            $foundPath = $zipPathWindows
          } elseif (Test-Path $zipPathUnix) {
            $foundPath = $zipPathUnix
          }
          
          if ($foundPath) {
            # Always normalize to forward slashes for the action
            $zipPathNormalized = $foundPath -replace '\\', '/'
            
            Write-Host "Found pre-built zip file: $foundPath"
            Write-Host "Normalized path for action: $zipPathNormalized"
            Write-Output "zip_exists=true" >> $env:GITHUB_OUTPUT
            # Output with forward slashes - use single quotes to prevent PowerShell from interpreting
            Write-Output "zip_path=$zipPathNormalized" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No pre-built zip found. You should build it locally using build-release.ps1 first."
            Write-Host "Expected location: $zipPathWindows or $zipPathUnix"
            Write-Output "zip_exists=false" >> $env:GITHUB_OUTPUT
          }
        shell: powershell

      - name: Verify zip file exists
        if: steps.check_zip.outputs.zip_exists == 'true'
        run: |
          $zipPathFromOutput = "${{ steps.check_zip.outputs.zip_path }}"
          Write-Host "Path from previous step: '$zipPathFromOutput'"
          Write-Host "Path contains backslashes: $($zipPathFromOutput -match '\\')"
          
          # Ensure forward slashes
          $zipPath = $zipPathFromOutput -replace '\\', '/'
          Write-Host "Normalized path: '$zipPath'"
          Write-Host "Current working directory: $(Get-Location)"
          Write-Host "Listing release directory:"
          Get-ChildItem -Path "release" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  - $($_.Name) ($($_.Length) bytes)"
          }
          
          # Try both path formats to find the file
          if (Test-Path $zipPath) {
            $fileInfo = Get-Item $zipPath
            Write-Host "File exists: $($fileInfo.FullName)"
            Write-Host "File size: $($fileInfo.Length) bytes"
            Write-Host "File will be attached to release as: $zipPath"
            # Verify it's not a source code archive by checking size (source archives are usually much larger)
            if ($fileInfo.Length -lt 10MB) {
              Write-Host "File size looks correct for a mod release (not a source code archive)"
            } else {
              Write-Warning "File size is large - this might be a source code archive!"
            }
            # Output the normalized path for the next step
            Write-Output "normalized_zip_path=$zipPath" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "Zip file not found at: $zipPath"
            exit 1
          }
        shell: powershell
        id: verify_zip

      - name: Create Release
        if: steps.check_zip.outputs.zip_exists == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.verify_zip.outputs.normalized_zip_path }}
          name: ${{ steps.parse_tag.outputs.mod_name }} v${{ steps.parse_tag.outputs.release_version }}
          tag_name: ${{ github.ref_name }}
          generate_release_notes: false
          body: |
            ## Installation Instructions
            
            1. Download the zip file below
            2. Extract the zip file
            3. Copy the extracted folder to your ONI mods directory:
               - **Windows**: `%USERPROFILE%\Documents\Klei\OxygenNotIncluded\mods\Local\`
               - **Linux**: `~/.config/unity3d/Klei/OxygenNotIncluded/mods/Local/`
               - **Mac**: `~/Library/Application Support/unity3d/Klei/OxygenNotIncluded/mods/Local/`
            4. The folder name should match the mod name (e.g., `${{ steps.parse_tag.outputs.mod_name }}`)
            5. Restart Oxygen Not Included or reload mods
            
            ## What's Included
            
            - Mod DLL file
            - PLib.dll (if required)
            - CommonLib.dll (if required)
            - mod.yaml
            - mod_info.yaml
            - preview.png
            - anim folder (if applicable)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Error if no zip found
        if: steps.check_zip.outputs.zip_exists != 'true'
        run: |
          Write-Error "No pre-built zip file found. Please build the release locally first using: .\build-release.ps1 -ModName `"${{ steps.parse_tag.outputs.mod_name }}`" -Version `"${{ steps.parse_tag.outputs.version }}`""
          exit 1
        shell: powershell

