name: Create Release

on:
  push:
    tags:
      - '**'

jobs:
  release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags

      - name: Parse tag
        id: parse_tag
        run: |
          $tag = "${{ github.ref_name }}"
          Write-Host "Tag: $tag"
          
          # Parse tag format: ModName-v1.2.3 or ModName-v1.2.3.4
          if ($tag -match '^(.+?)-v(\d+\.\d+\.\d+(?:\.\d+)?)$') {
            $modName = $matches[1]
            $version = $matches[2]
            
            # Extract release version without build number (e.g., "1.0.1.4" -> "1.0.1")
            $releaseVersion = $version
            if ($version -match '^(\d+\.\d+\.\d+)\.\d+$') {
              $releaseVersion = $matches[1]
            }
            
            Write-Host "Mod name: $modName"
            Write-Host "Full version: $version"
            Write-Host "Release version (without build): $releaseVersion"
            Write-Output "mod_name=$modName" >> $env:GITHUB_OUTPUT
            Write-Output "version=$version" >> $env:GITHUB_OUTPUT
            Write-Output "release_version=$releaseVersion" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "Invalid tag format. Expected: ModName-v1.2.3 or ModName-v1.2.3.4"
            exit 1
          }
        shell: powershell

      - name: Check for pre-built zip
        id: check_zip
        run: |
          $modName = "${{ steps.parse_tag.outputs.mod_name }}"
          $releaseVersion = "${{ steps.parse_tag.outputs.release_version }}"
          # Zip file uses release version (without build number)
          $zipPath = "release\$modName-v$releaseVersion.zip"
          
          if (Test-Path $zipPath) {
            Write-Host "Found pre-built zip file: $zipPath"
            Write-Output "zip_exists=true" >> $env:GITHUB_OUTPUT
            Write-Output "zip_path=$zipPath" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No pre-built zip found. You should build it locally using build-release.ps1 first."
            Write-Host "Expected location: $zipPath"
            Write-Output "zip_exists=false" >> $env:GITHUB_OUTPUT
          }
        shell: powershell

      - name: Create Release
        if: steps.check_zip.outputs.zip_exists == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.check_zip.outputs.zip_path }}
          name: ${{ steps.parse_tag.outputs.mod_name }} v${{ steps.parse_tag.outputs.release_version }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## Installation Instructions
            
            1. Download the zip file below
            2. Extract the zip file
            3. Copy the extracted folder to your ONI mods directory:
               - **Windows**: `%USERPROFILE%\Documents\Klei\OxygenNotIncluded\mods\Local\`
               - **Linux**: `~/.config/unity3d/Klei/OxygenNotIncluded/mods/Local/`
               - **Mac**: `~/Library/Application Support/unity3d/Klei/OxygenNotIncluded/mods/Local/`
            4. The folder name should match the mod name (e.g., `${{ steps.parse_tag.outputs.mod_name }}`)
            5. Restart Oxygen Not Included or reload mods
            
            ## What's Included
            
            - Mod DLL file
            - PLib.dll (if required)
            - CommonLib.dll (if required)
            - mod.yaml
            - mod_info.yaml
            - preview.png
            - anim folder (if applicable)
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Error if no zip found
        if: steps.check_zip.outputs.zip_exists != 'true'
        run: |
          Write-Error "No pre-built zip file found. Please build the release locally first using: .\build-release.ps1 -ModName `"${{ steps.parse_tag.outputs.mod_name }}`" -Version `"${{ steps.parse_tag.outputs.version }}`""
          exit 1
        shell: powershell

