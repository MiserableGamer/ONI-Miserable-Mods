name: Create Release

on:
  push:
    tags:
      - '**'

jobs:
  release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for tags
          ref: master  # Checkout master branch for commits

      - name: Parse tag
        id: parse_tag
        run: |
          $tag = "${{ github.ref_name }}"
          Write-Host "Tag: $tag"
          
          # Parse tag format: ModName-v1.2.3 or ModName-v1.2.3.4
          if ($tag -match '^(.+?)-v(\d+\.\d+\.\d+(?:\.\d+)?)$') {
            $modName = $matches[1]
            $version = $matches[2]
            
            # Extract release version without build number (e.g., "1.0.1.4" -> "1.0.1")
            $releaseVersion = $version
            if ($version -match '^(\d+\.\d+\.\d+)\.\d+$') {
              $releaseVersion = $matches[1]
            }
            
            Write-Host "Mod name: $modName"
            Write-Host "Full version: $version"
            Write-Host "Release version (without build): $releaseVersion"
            Write-Output "mod_name=$modName" >> $env:GITHUB_OUTPUT
            Write-Output "version=$version" >> $env:GITHUB_OUTPUT
            Write-Output "release_version=$releaseVersion" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "Invalid tag format. Expected: ModName-v1.2.3 or ModName-v1.2.3.4"
            exit 1
          }
        shell: powershell

      - name: Check for pre-built zip
        id: check_zip
        run: |
          $modName = "${{ steps.parse_tag.outputs.mod_name }}"
          $releaseVersion = "${{ steps.parse_tag.outputs.release_version }}"
          # Zip file uses release version (without build number), except for MiserableGamersMods which has no version
          # Use forward slashes for GitHub Actions compatibility
          if ($modName -eq "MiserableGamersMods") {
            $zipPath = "release/$modName.zip"
          } else {
            $zipPath = "release/$modName-v$releaseVersion.zip"
          }
          
          if (Test-Path $zipPath) {
            Write-Host "Found pre-built zip file: $zipPath"
            Write-Output "zip_exists=true" >> $env:GITHUB_OUTPUT
            Write-Output "zip_path=$zipPath" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No pre-built zip found. You should build it locally using build-release.ps1 first."
            Write-Host "Expected location: $zipPath"
            Write-Output "zip_exists=false" >> $env:GITHUB_OUTPUT
          }
        shell: powershell

      - name: Generate release body
        id: release_body
        if: steps.check_zip.outputs.zip_exists == 'true'
        run: |
          $modName = "${{ steps.parse_tag.outputs.mod_name }}"
          $releaseBody = ""
          
          if ($modName -eq "MiserableGamersMods") {
            $releaseBody = "## Installation Instructions`n`n" +
              "1. Download the zip file below`n" +
              "2. Extract the zip file`n" +
              "3. You will find a folder containing all mods`n" +
              "4. Copy each mod folder individually to your ONI mods directory:`n" +
              "   - **Windows**: ``%USERPROFILE%\Documents\Klei\OxygenNotIncluded\mods\Local\``n" +
              "   - **Linux**: ``~/.config/unity3d/Klei/OxygenNotIncluded/mods/Local/``n" +
              "   - **Mac**: ``~/Library/Application Support/unity3d/Klei/OxygenNotIncluded/mods/Local/``n" +
              "5. Each mod folder should be copied as-is (e.g., copy the `LongerArms` folder, not its contents)`n" +
              "6. Restart Oxygen Not Included or reload mods`n`n" +
              "## What's Included`n`n" +
              "This package contains all available mods from Miserable Gamer. Each mod includes:`n" +
              "- Mod DLL file`n" +
              "- PLib.dll (if required)`n" +
              "- CommonLib.dll (if required)`n" +
              "- mod.yaml`n" +
              "- mod_info.yaml`n" +
              "- preview.png`n" +
              "- anim folder (if applicable)"
          } else {
            $releaseBody = "## Installation Instructions`n`n" +
              "1. Download the zip file below`n" +
              "2. Extract the zip file`n" +
              "3. Copy the extracted folder to your ONI mods directory:`n" +
              "   - **Windows**: ``%USERPROFILE%\Documents\Klei\OxygenNotIncluded\mods\Local\``n" +
              "   - **Linux**: ``~/.config/unity3d/Klei/OxygenNotIncluded/mods/Local/``n" +
              "   - **Mac**: ``~/Library/Application Support/unity3d/Klei/OxygenNotIncluded/mods/Local/``n" +
              "4. The folder name should match the mod name (e.g., ``$modName``)`n" +
              "5. Restart Oxygen Not Included or reload mods`n`n" +
              "## What's Included`n`n" +
              "- Mod DLL file`n" +
              "- PLib.dll (if required)`n" +
              "- CommonLib.dll (if required)`n" +
              "- mod.yaml`n" +
              "- mod_info.yaml`n" +
              "- preview.png`n" +
              "- anim folder (if applicable)"
          }
          
          # Escape newlines for GitHub Actions output
          $releaseBody = $releaseBody -replace "`r?`n", "%0A"
          Write-Output "body=$releaseBody" >> $env:GITHUB_OUTPUT
        shell: powershell

      - name: Create Release
        if: steps.check_zip.outputs.zip_exists == 'true'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ steps.check_zip.outputs.zip_path }}
          name: ${{ steps.parse_tag.outputs.mod_name }} v${{ steps.parse_tag.outputs.release_version }}
          tag_name: ${{ github.ref_name }}
          body: ${{ steps.release_body.outputs.body }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update README with release link
        if: steps.check_zip.outputs.zip_exists == 'true'
        run: |
          $modName = "${{ steps.parse_tag.outputs.mod_name }}"
          $releaseVersion = "${{ steps.parse_tag.outputs.release_version }}"
          $tagName = "${{ github.ref_name }}"
          
          # Read README
          $readmePath = "README.md"
          $readmeContent = Get-Content $readmePath -Raw
          
          # New release link format (without emoji to avoid encoding issues)
          $newLink = "[Latest Release v$releaseVersion](https://github.com/MiserableGamer/ONI-Miserable-Mods/releases/tag/$tagName)"
          
          # Handle "MiserableGamersMods" (All Mods) differently
          if ($modName -eq "MiserableGamersMods") {
            # Update the "All Mods Package" section at the top
            $lines = $readmeContent -split "`r?`n"
            $updated = $false
            
            for ($i = 0; $i -lt $lines.Count; $i++) {
              # Look for the "All Mods Package" section
              if ($lines[$i] -match "## .*All Mods Package") {
                # Find the release link in the next few lines (look for "Latest Release" or "\[.*\]\(.*\)" pattern)
                for ($j = $i + 1; $j -lt [Math]::Min($i + 10, $lines.Count); $j++) {
                  if ($lines[$j] -match "Latest Release") {
                    $lines[$j] = $lines[$j] -replace '\[[^\]]*Latest Release[^\]]*\]\([^\)]+\)', $newLink
                    $updated = $true
                    Write-Host "Updated README release link for All Mods Package to v$releaseVersion"
                    break
                  }
                }
                break
              }
            }
          } else {
            # Find the mod section by looking for patterns that identify each mod
            $modPatterns = @{
              "MorningExercise" = "Morning Exercise"
              "CopyMaterialsTool" = "Copy Materials Tool"
              "EmptyStorage" = "Empty Storage"
              "LongerArms" = "Longer Arms"
              "DebugFogOfWar" = "Debug Fog of War"
              "BonbonTreeBoost" = "Bonbon Tree Boost"
              "ThresholdFixed" = "Threshold Fixed"
              "ResourceLimpet" = "Resource Limpet"
            }
            
            $modPattern = $modPatterns[$modName]
            if (-not $modPattern) {
              Write-Warning "No pattern mapping for mod: $modName. Skipping README update."
              exit 0
            }
            
            # Split into lines and find the mod section
            $lines = $readmeContent -split "`r?`n"
            $inModSection = $false
            $updated = $false
            
            for ($i = 0; $i -lt $lines.Count; $i++) {
              # Check if we're entering the mod section
              if ($lines[$i] -match "### .*$modPattern") {
                $inModSection = $true
              }
              # Once we're in the mod section, look for the release link line
              # Match "Latest Release" in markdown link format
              if ($inModSection -and $lines[$i] -match "Latest Release") {
                # Replace the entire markdown link that contains "Latest Release"
                $lines[$i] = $lines[$i] -replace '\[[^\]]*Latest Release[^\]]*\]\([^\)]+\)', $newLink
                $updated = $true
                Write-Host "Updated README release link for $modName to v$releaseVersion"
                break
              }
              # Stop looking if we've moved to the next mod section
              if ($inModSection -and $lines[$i] -match "^### " -and $lines[$i] -notmatch $modPattern) {
                break
              }
            }
          }
          
          if ($updated) {
            # Write updated README (preserve original line endings)
            $lineEnding = if ($readmeContent -match "`r`n") { "`r`n" } else { "`n" }
            Set-Content -Path $readmePath -Value ($lines -join $lineEnding) -NoNewline
          } else {
            Write-Warning "Could not find release link for $modName in README. Skipping update."
          }
        shell: powershell

      - name: Commit and push README update
        if: steps.check_zip.outputs.zip_exists == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # Ensure we're on master branch
          git checkout master
          git add README.md
          # Check if there are changes to commit (PowerShell syntax)
          git diff --staged --quiet
          if ($LASTEXITCODE -ne 0) {
            git commit -m "Update README: ${{ steps.parse_tag.outputs.mod_name }} v${{ steps.parse_tag.outputs.release_version }} release"
            git push origin master
          } else {
            Write-Host "No changes to commit in README"
          }
        shell: powershell

      - name: Error if no zip found
        if: steps.check_zip.outputs.zip_exists != 'true'
        run: |
          Write-Error "No pre-built zip file found. Please build the release locally first using: .\build-release.ps1 -ModName `"${{ steps.parse_tag.outputs.mod_name }}`" -Version `"${{ steps.parse_tag.outputs.version }}`""
          exit 1
        shell: powershell

